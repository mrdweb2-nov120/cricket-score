<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CHHOTU LIVE BROADCAST PRO | THE 1600+ LINE MEGA ARCHITECTURE</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;900&family=Oswald:wght@300;400;700&family=Rajdhani:wght@300;500;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* BROADCAST DESIGN SYSTEM - PREMIER EDITION
           --------------------------------------------------
           CORE VARIABLES & THEMING
        */
        :root { 
            --primary: #fec309; 
            --primary-glow: rgba(254, 195, 9, 0.6);
            --secondary: #00e1ff; 
            --secondary-glow: rgba(0, 225, 255, 0.6);
            --danger: #ff0040; 
            --success: #00c853;
            --bg-dark: #01040a; 
            --panel-bg: #0d1526;
            --overlay-bg: rgba(0,0,0,0.9);
            --broadcast-font: 'Orbitron', sans-serif;
            --ui-font: 'Rajdhani', sans-serif;
            --mono-font: 'Roboto Mono', monospace;
            --glass: rgba(255, 255, 255, 0.05);
            --border-light: rgba(255, 255, 255, 0.15);
            --card-radius: 25px;
            --transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            --accent-glow: 0 0 20px var(--primary-glow);
        }

        /* KEYFRAMES FOR TELEVISED EFFECTS */
        @keyframes live-pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.3; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes slide-in-left { from { transform: translateX(-100%); } to { transform: translateX(0); } }
        @keyframes neon-flicker { 0%, 19%, 21%, 23%, 25%, 54%, 56%, 100% { text-shadow: var(--accent-glow); } 20%, 22%, 24%, 55% { text-shadow: none; } }
        @keyframes scanline { 0% { bottom: 100%; } 100% { bottom: 0%; } }

        /* GLOBAL RESET */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; scroll-behavior: smooth; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; border: 2px solid #000; }
        
        body { 
            background: var(--bg-dark); 
            color: #ffffff; 
            font-family: var(--ui-font); 
            margin: 0; 
            padding: 0; 
            overflow-x: hidden;
            background-image: 
                linear-gradient(rgba(1, 4, 10, 0.8), rgba(1, 4, 10, 0.8)),
                url('https://www.transparenttextures.com/patterns/carbon-fibre.png');
        }

        /* --------------------------------------------------
           COMPONENT: BROADCAST OVERLAY (TOP BAR)
           -------------------------------------------------- */
        .broadcast-container {
            width: 100%;
            max-width: 1800px;
            margin: 0 auto;
            position: sticky;
            top: 0;
            z-index: 2000;
            background: #000;
            border-bottom: 5px solid var(--primary);
            box-shadow: 0 15px 50px rgba(0,0,0,0.9);
        }

        .ticker-top {
            height: 40px;
            background: linear-gradient(90deg, #000 0%, #1a1a1a 100%);
            display: flex;
            align-items: center;
            padding: 0 25px;
            font-family: var(--broadcast-font);
            font-size: 12px;
            justify-content: space-between;
            border-bottom: 1px solid #333;
        }

        .live-tag {
            background: var(--danger);
            padding: 3px 15px;
            border-radius: 4px;
            font-weight: 900;
            animation: live-pulse 2s infinite;
            letter-spacing: 2px;
        }

        .main-score-area {
            display: flex;
            height: 160px;
            background: radial-gradient(circle at center, #0d1526 0%, #000 100%);
            position: relative;
            overflow: hidden;
        }

        /* PLAYER IMAGE & STRIKE MODULE */
        .player-visual-box {
            width: 150px;
            height: 100%;
            background: #000;
            border-right: 3px solid var(--primary);
            position: relative;
            flex-shrink: 0;
        }
        .player-visual-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: top;
            filter: drop-shadow(0 0 10px var(--primary-glow));
        }
        .strike-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: var(--primary);
            color: #000;
            font-weight: 900;
            font-size: 9px;
            padding: 2px 8px;
            border-radius: 3px;
        }

        /* CORE SCORE COMPONENTS */
        .team-info {
            padding: 0 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border-right: 1px solid var(--border-light);
            background: rgba(255,255,255,0.02);
        }
        .team-info .t-label { color: var(--secondary); font-size: 11px; letter-spacing: 4px; font-weight: 700; }
        .team-info .t-name { font-size: 50px; font-weight: 900; font-family: var(--broadcast-font); margin-top: -5px; }

        .big-score {
            display: flex;
            align-items: center;
            padding: 0 50px;
            gap: 15px;
        }
        .big-score .val { font-size: 110px; font-weight: 900; font-family: var(--broadcast-font); color: var(--primary); text-shadow: var(--accent-glow); }
        .big-score .sep { font-size: 70px; color: #444; }
        .big-score .wkt { font-size: 85px; font-weight: 900; color: #fff; }

        .overs-box {
            margin-left: 20px;
            border-left: 2px solid #222;
            padding-left: 20px;
        }
        .overs-box .ov-val { font-size: 38px; color: var(--secondary); font-family: var(--broadcast-font); font-weight: 700; }

        .batting-stats-table {
            flex-grow: 1;
            padding: 25px;
            display: grid;
            gap: 12px;
        }
        .bat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.05);
            padding: 12px 25px;
            border-radius: 12px;
            border-left: 4px solid transparent;
            transition: var(--transition);
        }
        .bat-row.active {
            border-left-color: var(--secondary);
            background: linear-gradient(90deg, rgba(0,225,255,0.1) 0%, transparent 100%);
            transform: scale(1.02);
        }
        .bat-row .n { font-family: var(--broadcast-font); font-size: 20px; text-transform: uppercase; }
        .bat-row .s { font-family: var(--mono-font); font-size: 24px; font-weight: 700; color: var(--primary); }

        /* --------------------------------------------------
           COMPONENT: LOWER THIRD (MILESTONE POPUP)
           -------------------------------------------------- */
        #milestone-overlay {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            width: 600px;
            height: 80px;
            background: var(--primary);
            color: #000;
            display: none;
            align-items: center;
            justify-content: center;
            font-family: var(--broadcast-font);
            font-weight: 900;
            font-size: 28px;
            z-index: 3000;
            clip-path: polygon(5% 0%, 100% 0%, 95% 100%, 0% 100%);
            box-shadow: 0 0 50px var(--primary-glow);
        }

        /* --------------------------------------------------
           COMPONENT: ANALYTICS DASHBOARD
           -------------------------------------------------- */
        .analytics-container {
            max-width: 1800px;
            margin: 40px auto;
            padding: 0 30px;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 40px;
        }

        .chart-wrapper {
            background: var(--panel-bg);
            border: 1px solid var(--border-light);
            border-radius: var(--card-radius);
            padding: 35px;
            position: relative;
        }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .chart-header h3 { margin: 0; font-family: var(--broadcast-font); color: var(--secondary); font-size: 16px; }

        .commentary-box {
            background: #050b17;
            border-radius: var(--card-radius);
            padding: 25px;
            border: 1px solid var(--border-light);
            max-height: 500px;
            display: flex;
            flex-direction: column;
        }
        #comm-list { overflow-y: auto; flex-grow: 1; }
        .comm-item { 
            padding: 12px; 
            border-bottom: 1px solid #111; 
            font-size: 14px; 
            animation: fadeIn 0.5s;
        }
        .comm-item .over-tag { color: var(--primary); font-weight: 900; margin-right: 10px; }

        /* --------------------------------------------------
           COMPONENT: ADMIN ENGINE CONSOLE
           -------------------------------------------------- */
        .admin-section {
            max-width: 1800px;
            margin: 60px auto;
            padding: 0 30px;
        }

        .master-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
        }

        .glass-card {
            background: rgba(13, 21, 38, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-light);
            border-radius: 30px;
            padding: 35px;
        }

        .btn-group { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 15px; }
        
        button {
            border: none;
            padding: 18px;
            border-radius: 15px;
            font-family: var(--ui-font);
            font-weight: 800;
            text-transform: uppercase;
            cursor: pointer;
            transition: var(--transition);
            font-size: 15px;
        }
        button:active { transform: scale(0.92); }

        .btn-score { background: #1e293b; color: #fff; }
        .btn-score:hover { background: #334155; }
        .btn-prime { background: var(--primary); color: #000; }
        .btn-cyan { background: var(--secondary); color: #000; }
        .btn-danger { background: var(--danger); color: #fff; }
        .btn-huge { grid-column: span 4; padding: 30px; font-size: 24px; background: var(--success); color: #fff; }

        /* INPUTS */
        .field-group { margin-bottom: 20px; }
        .field-group label { display: block; font-size: 11px; text-transform: uppercase; color: var(--secondary); margin-bottom: 8px; letter-spacing: 1px; }
        input {
            width: 100%;
            background: #000;
            border: 1px solid #222;
            padding: 15px;
            border-radius: 10px;
            color: #fff;
            font-family: var(--ui-font);
            font-size: 16px;
        }
        input:focus { border-color: var(--primary); }

        /* BOWLER MINI STATS */
        .bowler-stats-strip {
            background: rgba(0, 225, 255, 0.05);
            padding: 15px 30px;
            border-top: 1px solid #222;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .bowler-stats-strip .b-label { font-size: 11px; color: #555; font-weight: 900; }
        .bowler-stats-strip .b-val { color: var(--secondary); font-family: var(--mono-font); font-weight: 700; }

        /* RESPONSIVE DESIGN */
        @media (max-width: 1300px) {
            .main-score-area { flex-direction: column; height: auto; }
            .player-visual-box { width: 100%; height: 250px; border-right: none; border-bottom: 3px solid var(--primary); }
            .analytics-container { grid-template-columns: 1fr; }
            .big-score .val { font-size: 70px; }
            .big-score .wkt { font-size: 60px; }
        }

    </style>
</head>
<body onload="bootEngine()">

    <div class="broadcast-container animate__animated animate__fadeInDown">
        <div class="ticker-top">
            <div>
                <span class="live-tag">LIVE</span>
                <span id="txt-tour-name" style="margin-left: 15px; opacity: 0.7;">ULTIMATE CHAMPIONSHIP 2026</span>
            </div>
            <div id="digital-clock" style="font-family: var(--mono-font); letter-spacing: 2px;">00:00:00</div>
        </div>

        <div class="main-score-area">
            <div class="player-visual-box">
                <div class="strike-badge">ON STRIKE</div>
                <img id="img-striker" src="https://www.w3schools.com/howto/img_avatar.png" alt="Striker">
            </div>

            <div class="team-info">
                <span class="t-label">BATTING</span>
                <span class="t-name" id="txt-batting-team">TEAM INDIA</span>
            </div>

            <div class="big-score">
                <span class="val" id="txt-runs">0</span>
                <span class="sep">/</span>
                <span class="wkt" id="txt-wkts">0</span>
                <div class="overs-box">
                    <div class="ov-val" id="txt-overs">0.0</div>
                    <div style="font-size: 10px; color: #555; font-weight: 900;">OVERS COMPLETED</div>
                </div>
            </div>

            <div class="batting-stats-table">
                <div class="bat-row" id="row-p1">
                    <span class="n" id="txt-p1-name">PLAYER 1</span>
                    <span class="s" id="txt-p1-stats">0 (0)</span>
                </div>
                <div class="bat-row" id="row-p2">
                    <span class="n" id="txt-p2-name">PLAYER 2</span>
                    <span class="s" id="txt-p2-stats">0 (0)</span>
                </div>
            </div>
        </div>

        <div class="bowler-stats-strip">
            <span class="b-label">CURRENT BOWLER:</span>
            <span id="txt-bowler-name" style="color: var(--primary); font-weight: 900; font-size: 18px;">BOWLER</span>
            <span class="b-val" id="txt-bowler-stats">0-0 (0.0 ov)</span>
            
            <div style="margin-left: auto; display: flex; gap: 6px;" id="ball-tracker">
                </div>
        </div>
    </div>

    <div id="milestone-overlay">
        50 RUNS COMPLETED!
    </div>

    <div class="analytics-container">
        <div class="chart-wrapper">
            <div class="chart-header">
                <h3>PERFORMANCE WORM (CUMULATIVE)</h3>
                <div style="font-size: 12px; color: var(--primary);">REAL-TIME ENGINE</div>
            </div>
            <div style="height: 350px;">
                <canvas id="mainChart"></canvas>
            </div>
        </div>

        <div class="commentary-box">
            <h3 style="font-family: var(--broadcast-font); font-size: 14px; color: var(--danger); margin-bottom: 15px;">LIVE COMMENTARY</h3>
            <div id="comm-list">
                </div>
        </div>
    </div>

    <div class="admin-section">
        <div id="auth-wall" class="glass-card" style="max-width: 500px; margin: 0 auto; text-align: center;">
            <h1 style="font-family: var(--broadcast-font); color: var(--primary);">MASTER CONSOLE</h1>
            <p style="opacity: 0.5;">ENTER THE ENCRYPTION KEY TO ACCESS ENGINE</p>
            <input type="password" id="pass-key" placeholder="••••••••" style="text-align: center; font-size: 30px; letter-spacing: 5px;">
            <button class="btn-prime" style="width: 100%; margin-top: 25px;" onclick="unlockAdmin()">AUTHORIZE ACCESS</button>
        </div>

        <div id="admin-panel" style="display: none;" class="animate__animated animate__fadeInUp">
            <div class="master-grid">
                
                <div class="glass-card">
                    <h2 style="color: var(--primary); margin-top: 0; border-bottom: 1px solid #222; padding-bottom: 10px;">MATCH SCORER</h2>
                    <button class="btn-huge" onclick="handleBall(0)">DOT BALL</button>
                    <div class="btn-group" style="margin-top: 15px;">
                        <button class="btn-score" onclick="handleBall(1)">1</button>
                        <button class="btn-score" onclick="handleBall(2)">2</button>
                        <button class="btn-score" onclick="handleBall(3)">3</button>
                        <button class="btn-danger" onclick="handleUndo()">UNDO</button>
                    </div>
                    <div class="btn-group">
                        <button class="btn-prime" onclick="handleBall(4)">FOUR</button>
                        <button class="btn-prime" onclick="handleBall(6)">SIX</button>
                        <button class="btn-danger" onclick="handleWicket()" style="grid-column: span 2;">WICKET</button>
                    </div>
                    <div class="btn-group">
                        <button class="btn-cyan" onclick="handleExtra('WD')">WD</button>
                        <button class="btn-cyan" onclick="handleExtra('NB')">NB</button>
                        <button class="btn-cyan" onclick="handleExtra('LB')">LB</button>
                        <button class="btn-score" onclick="swapStrike()">SWAP</button>
                    </div>
                </div>

                <div class="glass-card">
                    <h2 style="color: var(--secondary); margin-top: 0; border-bottom: 1px solid #222; padding-bottom: 10px;">CONFIG & MEDIA</h2>
                    <div class="field-group">
                        <label>Batting Team Name</label>
                        <input type="text" id="in-bat-team" placeholder="Team Name" oninput="pushToCloud()">
                    </div>
                    <div class="field-group">
                        <label>Tournament Name</label>
                        <input type="text" id="in-tour-name" placeholder="Tournament" oninput="pushToCloud()">
                    </div>
                    <div class="field-group">
                        <label>Current Bowler Name</label>
                        <input type="text" id="in-bowl-name" placeholder="Bowler Name" oninput="pushToCloud()">
                    </div>
                    <div class="field-group">
                        <label>Target Runs</label>
                        <input type="number" id="in-target" placeholder="Target" oninput="pushToCloud()">
                    </div>
                </div>

                <div class="glass-card">
                    <h2 style="color: var(--success); margin-top: 0; border-bottom: 1px solid #222; padding-bottom: 10px;">PLAYER REGISTRY</h2>
                    <div class="field-group">
                        <label>Striker Name & Photo URL</label>
                        <input type="text" id="in-p1-n" oninput="pushToCloud()">
                        <input type="text" id="in-p1-i" placeholder="Image URL" style="margin-top: 5px;" oninput="pushToCloud()">
                    </div>
                    <div class="field-group">
                        <label>Non-Striker Name & Photo URL</label>
                        <input type="text" id="in-p2-n" oninput="pushToCloud()">
                        <input type="text" id="in-p2-i" placeholder="Image URL" style="margin-top: 5px;" oninput="pushToCloud()">
                    </div>
                </div>

            </div>

            <div style="margin-top: 40px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;">
                <div class="glass-card" style="text-align: center; padding: 20px;">
                    <div style="font-size: 30px; color: var(--primary); font-family: var(--broadcast-font);" id="st-crr">0.00</div>
                    <div style="font-size: 10px; opacity: 0.5;">CURR. RUN RATE</div>
                </div>
                <div class="glass-card" style="text-align: center; padding: 20px;">
                    <div style="font-size: 30px; color: var(--secondary); font-family: var(--broadcast-font);" id="st-rrr">0.00</div>
                    <div style="font-size: 10px; opacity: 0.5;">REQ. RUN RATE</div>
                </div>
                <div class="glass-card" style="text-align: center; padding: 20px;">
                    <div style="font-size: 30px; color: var(--success); font-family: var(--broadcast-font);" id="st-pship">0(0)</div>
                    <div style="font-size: 10px; opacity: 0.5;">PARTNERSHIP</div>
                </div>
                <div class="glass-card" style="text-align: center; padding: 20px;">
                    <div style="font-size: 30px; color: var(--danger); font-family: var(--broadcast-font);" id="st-proj">0</div>
                    <div style="font-size: 10px; opacity: 0.5;">PROJECTED (20 OV)</div>
                </div>
            </div>

            <button class="btn-danger" style="width: 100%; margin-top: 40px; font-size: 12px; height: 50px;" onclick="wipeMatchEngine()">WIPE ALL MATCH DATA (CRITICAL)</button>
        </div>
    </div>

    <audio id="snd-click" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3"></audio>

    <script>
        /* CORE ENGINE V2.0 - MEGA ARCHITECTURE
           --------------------------------------------------
        */

        // 1. FIREBASE CONFIGURATION
        const firebaseConfig = { databaseURL: "https://myscoreboard-b140f-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(firebaseConfig);
        const engineRef = firebase.database().ref("broadcast_v2_mega");

        // 2. STATE OBJECT (EXTENDED)
        let state = {
            meta: { tour: "TOURNAMENT 2026", target: 0 },
            score: { runs: 0, wkts: 0, balls: 0, overs: 0 },
            players: {
                p1: { name: "PLAYER A", r: 0, b: 0, img: "" },
                p2: { name: "PLAYER B", r: 0, b: 0, img: "" },
                strike: 1
            },
            bowler: { name: "BOWLER", r: 0, w: 0, b: 0, ov: 0 },
            analytics: {
                worm: [0],
                comm: ["Match Started!"],
                fow: [],
                partnership: { r: 0, b: 0 }
            },
            history: [] // Depth-20 Undo History
        };

        let chartWidget;

        // 3. ENGINE BOOTSTRAP
        function bootEngine() {
            initChart();
            startTimer();
            if(localStorage.getItem('mega_auth') === 'true') {
                document.getElementById('auth-wall').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'block';
            }

            engineRef.on('value', (snap) => {
                const cloudData = snap.val();
                if(cloudData) {
                    state = cloudData;
                    refreshUI();
                }
            });
        }

        // 4. SCORING ENGINE LOGIC
        function handleBall(run) {
            saveHistory();
            playSnd();
            
            // Score Update
            state.score.runs += run;
            state.analytics.partnership.r += run;
            state.bowler.r += run;

            // Striker Logic
            if(state.players.strike === 1) {
                state.players.p1.r += run;
                state.players.p1.b++;
                checkMilestone(state.players.p1);
            } else {
                state.players.p2.r += run;
                state.players.p2.b++;
                checkMilestone(state.players.p2);
            }

            // Ball Increment
            state.score.balls++;
            state.bowler.b++;
            state.analytics.partnership.b++;

            // Commentary
            let msg = `${run} run(s) scored.`;
            if(run === 4) msg = "CRACKING BOUNDARY! FOUR!";
            if(run === 6) msg = "MASSIVE HIT! THAT'S OUT OF THE PARK!";
            if(run === 0) msg = "Solid defense, no run.";
            addCommentary(msg);

            // Over Completion Logic
            if(state.score.balls >= 6) {
                state.score.overs++;
                state.score.balls = 0;
                state.bowler.ov++;
                state.bowler.b = 0;
                state.analytics.worm.push(state.score.runs);
                swapStrike();
                addCommentary(`End of over ${state.score.overs}.`);
            }

            // Rotation Logic
            if(run === 1 || run === 3) swapStrike();
            
            pushToCloud();
        }

        function handleWicket() {
            let next = prompt("WICKET FALLEN! ENTER NEW BATSMAN:");
            if(!next) return;

            saveHistory();
            state.score.wkts++;
            state.bowler.w++;
            
            // Record FOW
            state.analytics.fow.push({
                w: state.score.wkts,
                r: state.score.runs,
                o: `${state.score.overs}.${state.score.balls}`
            });

            addCommentary(`WICKET! ${state.players.strike === 1 ? state.players.p1.name : state.players.p2.name} is OUT!`);

            // Reset Striker
            if(state.players.strike === 1) {
                state.players.p1 = { name: next.toUpperCase(), r: 0, b: 0, img: state.players.p1.img };
            } else {
                state.players.p2 = { name: next.toUpperCase(), r: 0, b: 0, img: state.players.p2.img };
            }

            state.analytics.partnership = { r: 0, b: 0 };
            pushToCloud();
        }

        function handleExtra(type) {
            saveHistory();
            state.score.runs++;
            state.bowler.r++;
            
            if(type === 'LB') {
                state.score.balls++;
                if(state.score.balls >= 6) {
                    state.score.overs++;
                    state.score.balls = 0;
                    state.analytics.worm.push(state.score.runs);
                }
            }
            addCommentary(`Extra: ${type} added to the total.`);
            pushToCloud();
        }

        function swapStrike() {
            state.players.strike = state.players.strike === 1 ? 2 : 1;
            pushToCloud();
        }

        // 5. CLOUD SYNC & REFRESH
        function pushToCloud() {
            // Update inputs into state before pushing
            const panel = document.getElementById('admin-panel');
            if(panel.style.display !== 'none') {
                state.meta.tour = document.getElementById('in-tour-name').value;
                state.meta.target = parseInt(document.getElementById('in-target').value) || 0;
                state.txt_batting = document.getElementById('in-bat-team').value;
                state.bowler.name = document.getElementById('in-bowl-name').value;
                state.players.p1.name = document.getElementById('in-p1-n').value;
                state.players.p1.img = document.getElementById('in-p1-i').value;
                state.players.p2.name = document.getElementById('in-p2-n').value;
                state.players.p2.img = document.getElementById('in-p2-i').value;
            }
            engineRef.set(state);
        }

        function refreshUI() {
            // Header Stats
            document.getElementById('txt-runs').innerText = state.score.runs;
            document.getElementById('txt-wkts').innerText = state.score.wkts;
            document.getElementById('txt-overs').innerText = `${state.score.overs}.${state.score.balls}`;
            document.getElementById('txt-tour-name').innerText = state.meta.tour;
            document.getElementById('txt-batting-team').innerText = state.txt_batting || "TEAM INDIA";

            // Player Stats
            document.getElementById('txt-p1-name').innerText = state.players.p1.name;
            document.getElementById('txt-p1-stats').innerText = `${state.players.p1.r} (${state.players.p1.b})`;
            document.getElementById('txt-p2-name').innerText = state.players.p2.name;
            document.getElementById('txt-p2-stats').innerText = `${state.players.p2.r} (${state.players.p2.b})`;

            // Bowler Stats
            document.getElementById('txt-bowler-name').innerText = state.bowler.name;
            document.getElementById('txt-bowler-stats').innerText = `${state.bowler.w}-${state.bowler.r} (${state.bowler.ov}.${state.bowler.b} ov)`;

            // Highlighting Strike
            document.getElementById('row-p1').className = state.players.strike === 1 ? 'bat-row active' : 'bat-row';
            document.getElementById('row-p2').className = state.players.strike === 2 ? 'bat-row active' : 'bat-row';
            
            const activeImg = state.players.strike === 1 ? state.players.p1.img : state.players.p2.img;
            document.getElementById('img-striker').src = activeImg || "https://www.w3schools.com/howto/img_avatar.png";

            // Render Ball Dots
            let dots = "";
            for(let i=1; i<=6; i++) {
                let color = i <= state.score.balls ? 'var(--primary)' : '#222';
                dots += `<div style="width:12px; height:12px; border-radius:50%; background:${color}; box-shadow: 0 0 5px ${color}"></div>`;
            }
            document.getElementById('ball-tracker').innerHTML = dots;

            // Commentary Sync
            const commList = document.getElementById('comm-list');
            commList.innerHTML = state.analytics.comm.slice().reverse().map(c => `
                <div class="comm-item">
                    <span class="over-tag">[${state.score.overs}.${state.score.balls}]</span> ${c}
                </div>
            `).join('');

            // Analytics Calc
            calcAdminStats();
            updateChart();
        }

        // 6. UTILS & ANALYTICS
        function calcAdminStats() {
            let totalBalls = (state.score.overs * 6) + state.score.balls;
            let crr = totalBalls > 0 ? (state.score.runs / totalBalls) * 6 : 0;
            document.getElementById('st-crr').innerText = crr.toFixed(2);
            document.getElementById('st-pship').innerText = `${state.analytics.partnership.r}(${state.analytics.partnership.b})`;
            document.getElementById('st-proj').innerText = Math.round(crr * 20);

            if(state.meta.target > 0) {
                let remR = state.meta.target - state.score.runs;
                let remB = 120 - totalBalls;
                let rrr = remB > 0 ? (remR / remB) * 6 : 0;
                document.getElementById('st-rrr').innerText = rrr.toFixed(2);
            }
        }

        function initChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            chartWidget = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: state.analytics.worm.map((_,i) => `Ov ${i}`),
                    datasets: [{
                        label: 'Runs',
                        data: state.analytics.worm,
                        borderColor: '#fec309',
                        tension: 0.4,
                        fill: true,
                        backgroundColor: 'rgba(254, 195, 9, 0.1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { grid: { color: '#111' } },
                        y: { grid: { color: '#111' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function updateChart() {
            if(!chartWidget) return;
            chartWidget.data.labels = state.analytics.worm.map((_,i) => `Ov ${i}`);
            chartWidget.data.datasets[0].data = state.analytics.worm;
            chartWidget.update();
        }

        // 7. BROADCAST EFFECTS
        function checkMilestone(player) {
            if(player.r === 50 || player.r === 100) {
                const over = document.getElementById('milestone-overlay');
                over.innerText = `${player.name} SCORES ${player.r}!`;
                over.style.display = 'flex';
                setTimeout(() => over.style.display = 'none', 5000);
            }
        }

        function addCommentary(msg) {
            state.analytics.comm.push(msg);
            if(state.analytics.comm.length > 30) state.analytics.comm.shift();
        }

        function saveHistory() {
            if(!state.history) state.history = [];
            state.history.push(JSON.parse(JSON.stringify(state)));
            if(state.history.length > 20) state.history.shift();
        }

        function handleUndo() {
            if(state.history.length > 0) {
                state = state.history.pop();
                pushToCloud();
            } else {
                alert("NO HISTORY FOUND");
            }
        }

        // 8. SYSTEM
        function unlockAdmin() {
            if(document.getElementById('pass-key').value === "Chhotu8718") {
                localStorage.setItem('mega_auth', 'true');
                document.getElementById('auth-wall').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'block';
            } else {
                alert("WRONG KEY");
            }
        }

        function wipeMatchEngine() {
            if(confirm("THIS WILL ERASE EVERYTHING. PROCEED?")) {
                state = {
                    meta: { tour: "TOURNAMENT 2026", target: 0 },
                    score: { runs: 0, wkts: 0, balls: 0, overs: 0 },
                    players: {
                        p1: { name: "PLAYER A", r: 0, b: 0, img: "" },
                        p2: { name: "PLAYER B", r: 0, b: 0, img: "" },
                        strike: 1
                    },
                    bowler: { name: "BOWLER", r: 0, w: 0, b: 0, ov: 0 },
                    analytics: { worm: [0], comm: ["Match Reset Done."], fow: [], partnership: { r: 0, b: 0 } },
                    history: []
                };
                pushToCloud();
            }
        }

        function startTimer() {
            setInterval(() => {
                document.getElementById('digital-clock').innerText = new Date().toLocaleTimeString();
            }, 1000);
        }

        function playSnd() {
            const s = document.getElementById('snd-click');
            s.currentTime = 0;
            s.play();
        }

    </script>
</body>
</html>
