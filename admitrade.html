<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Nova | Master Admin</title>

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary: #00e5ff;
            --primary-hover: #00bcd4;
            --bg-dark: #020b13;
            --card-bg: rgba(11, 31, 45, 0.9);
            --text-main: #ffffff;
            --text-dim: #b5dfff;
            --danger: #ff4d4d;
            --success: #2ecc71;
        }

        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at bottom left, #0a2e46, #020b13);
            color: var(--text-main);
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        /* --- UI Components --- */
        .glass-panel {
            background: var(--card-bg);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        h1, h2, h3 { font-family: 'Montserrat', sans-serif; margin: 0; }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .header h1 {
            background: linear-gradient(to right, #fff, var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 24px;
        }

        /* --- Stats Grid --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.03);
            padding: 20px;
            border-radius: 15px;
            border-left: 4px solid var(--primary);
            transition: 0.3s;
        }

        .stat-card:hover { transform: translateY(-5px); background: rgba(255,255,255,0.06); }
        .stat-card p { font-size: 12px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 5px; }
        .stat-card h2 { font-size: 28px; color: var(--primary); }

        /* --- Search & Filters --- */
        .search-bar {
            position: relative;
            margin: 20px 0;
        }

        .search-bar input {
            width: 100%;
            padding: 15px 15px 15px 45px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: #fff;
            box-sizing: border-box;
            outline: none;
        }

        .search-bar i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--primary); }

        /* --- Table Styling --- */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 15px; background: rgba(0, 229, 255, 0.1); color: var(--primary); font-size: 13px; text-transform: uppercase; }
        td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 14px; }
        tr:hover { background: rgba(255,255,255,0.02); }

        /* --- Action Buttons --- */
        .btn {
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
            font-size: 12px;
        }
        .btn-edit { background: var(--primary); color: #000; margin-right: 5px; }
        .btn-del { background: var(--danger); color: #fff; }
        .btn:hover { opacity: 0.8; transform: scale(1.05); }

        /* --- Login Overlay --- */
        #adminAuth {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-dark); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .auth-card {
            background: var(--card-bg); padding: 40px; border-radius: 20px;
            border: 1px solid var(--primary); text-align: center;
            width: 90%; max-width: 350px;
        }
        .auth-card input {
            width: 100%; padding: 12px; margin: 15px 0; background: #000;
            border: 1px solid #333; color: #fff; border-radius: 8px; box-sizing: border-box;
        }

        .hidden { display: none; }
        .status-pill { padding: 4px 8px; border-radius: 20px; font-size: 10px; font-weight: bold; background: var(--success); color: #000; }
    </style>
</head>
<body>

    <div id="adminAuth">
        <div class="auth-card">
            <i class="fa-solid fa-user-shield" style="font-size: 40px; color: var(--primary); margin-bottom: 15px;"></i>
            <h1>Admin Login</h1>
            <p style="color: var(--text-dim); font-size: 13px;">Enter Master Password</p>
            <input type="password" id="masterKey" placeholder="••••••••">
            <button onclick="checkAuth()" style="width: 100%; background: var(--primary); border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold;">Unlock Dashboard</button>
        </div>
    </div>

    <div id="adminUI" class="hidden">
        
        <div class="glass-panel header">
            <div>
                <h1>Trade Nova Control Panel</h1>
                <p style="font-size: 12px; color: var(--text-dim);">Real-time User Management System</p>
            </div>
            <button class="btn btn-del" onclick="location.reload()">Logout <i class="fa-solid fa-power-off"></i></button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <p>Total Registered</p>
                <h2 id="totalUsers">0</h2>
            </div>
            <div class="stat-card">
                <p>New Members (Today)</p>
                <h2 id="todayUsers">0</h2>
            </div>
            <div class="stat-card">
                <p>Database Status</p>
                <h2 style="color: var(--success); font-size: 18px;">CONNECTED</h2>
            </div>
        </div>

        <div class="glass-panel" style="margin-top: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>Member Directory</h2>
                <button class="btn btn-edit" onclick="refreshData()"><i class="fa-solid fa-rotate"></i> Sync Data</button>
            </div>

            <div class="search-bar">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="text" id="userSearch" placeholder="Search by Phone or Name..." onkeyup="filterUsers()">
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>User Details</th>
                            <th>Phone Number</th>
                            <th>Login Password</th>
                            <th>Joining Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody">
                        </tbody>
                </table>
            </div>
        </div>

        <div class="glass-panel">
            <h2>Quick Settings</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 15px;">
                <div>
                    <p style="font-size: 12px; margin-bottom: 5px;">Update Course URL</p>
                    <input type="text" id="newUrl" placeholder="https://..." style="width: 80%; padding: 10px; border-radius: 8px; background: #000; border: 1px solid #333; color: #fff;">
                    <button class="btn btn-edit" onclick="updateSiteUrl()">Update</button>
                </div>
            </div>
        </div>
    </div>

<script>
// --- FIREBASE CONFIG (Matches your provided code) ---
firebase.initializeApp({
  apiKey: "AIzaSyDdlhcnyqPJACCF0Aen8NLga8bkBzATNFM",
  authDomain: "tradenovaaccess.firebaseapp.com",
  projectId: "tradenovaaccess"
});
const db = firebase.firestore();

// --- 1. ADMIN AUTHENTICATION ---
function checkAuth() {
    const key = masterKey.value;
    if(key === "admin123") { // <-- अपना एडमिन पासवर्ड यहाँ बदलें
        adminAuth.classList.add('hidden');
        adminUI.classList.remove('hidden');
        refreshData();
    } else {
        alert("Wrong Master Password!");
    }
}

// --- 2. DATA LOADING & STATS ---
async function refreshData() {
    const tableBody = document.getElementById('userTableBody');
    tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center">Fetching data from Cloud...</td></tr>';
    
    try {
        const snapshot = await db.collection("users").orderBy("created", "desc").get();
        const users = [];
        let todayCount = 0;
        const now = new Date().toDateString();

        snapshot.forEach(doc => {
            const data = doc.data();
            users.push({ id: doc.id, ...data });

            // Count today's members
            if(data.created) {
                const joinDate = data.created.toDate ? data.created.toDate().toDateString() : new Date(data.created).toDateString();
                if(joinDate === now) todayCount++;
            }
        });

        renderTable(users);
        document.getElementById('totalUsers').innerText = snapshot.size;
        document.getElementById('todayUsers').innerText = todayCount;

    } catch(e) {
        console.error(e);
        tableBody.innerHTML = '<tr><td colspan="6" style="color:red">Error loading data.</td></tr>';
    }
}

// --- 3. RENDER TABLE ---
function renderTable(data) {
    const tableBody = document.getElementById('userTableBody');
    tableBody.innerHTML = "";

    data.forEach(user => {
        // Decode password (atob matches your btoa hashing)
        let realPass = "Error";
        try { realPass = atob(user.password); } catch(e) { realPass = "Encrypted"; }

        // Format Date
        let dateStr = "N/A";
        if(user.created) {
            const d = user.created.toDate ? user.created.toDate() : new Date(user.created);
            dateStr = d.toLocaleDateString('en-GB') + " " + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        tableBody.innerHTML += `
            <tr class="user-row">
                <td>
                    <div style="font-weight:600">${user.name}</div>
                    <div style="font-size:11px; color:var(--text-dim)">ID: ${user.phone}</div>
                </td>
                <td>${user.phone}</td>
                <td style="font-family: monospace; color: var(--primary)">${realPass}</td>
                <td style="font-size: 12px;">${dateStr}</td>
                <td><span class="status-pill">${user.status || 'Active'}</span></td>
                <td>
                    <button class="btn btn-edit" onclick="resetUserPass('${user.phone}')"><i class="fa-solid fa-key"></i></button>
                    <button class="btn btn-del" onclick="deleteUser('${user.phone}')"><i class="fa-solid fa-trash"></i></button>
                </td>
            </tr>
        `;
    });
}

// --- 4. SEARCH FUNCTION ---
function filterUsers() {
    const query = userSearch.value.toLowerCase();
    const rows = document.querySelectorAll('.user-row');
    
    rows.forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(query) ? "" : "none";
    });
}

// --- 5. MANAGEMENT ACTIONS ---
async function deleteUser(id) {
    if(confirm("Are you sure? This member will lose all access immediately!")) {
        await db.collection("users").doc(id).delete();
        refreshData();
    }
}

async function resetUserPass(id) {
    const newPlain = prompt("Enter new password for this user:");
    if(newPlain) {
        await db.collection("users").doc(id).update({
            password: btoa(newPlain)
        });
        alert("Password updated and encrypted!");
        refreshData();
    }
}

async function updateSiteUrl() {
    const url = newUrl.value.trim();
    if(!url) return alert("Enter a valid URL");
    
    await db.collection("config").doc("siteSettings").set({
        courseUrl: url
    }, { merge: true });
    
    alert("Main Website Course Link Updated!");
}
</script>

</body>
</html>
